# 上载下载任务接口文档

> 该文档包含了影视资源母带的上传下载任务中Web端及本地客户端需要使用到的接口

## 请求主机及调试参数

> 测试环境地址: ```测试环境地址 http://101.81.249.79:8000```

> 正式环境地址: 等待给出

> 关于测试是的参数

```
1. 所有的请求头中携带 HTTP_TOKEN 字段，内容为游览器调起客户端是传入的用户token
2. 上载公有块：来自游览器的参数中需要用于接口的是series_id, 测试环境传任意数字
3. 下载公有块：调用创建下载接口的souce_id 取在成功上载公有块时，调用更新上载公有块状态后返回数据中的data字段中的source_id用于下载
```



```
文件上载下载任务流程(不做参考，实际请以产品提供的开发文档为主)
1. 上载任务流程
    1. 用户在网页点击上载影片后选择文件夹后点击确定。调起客户端，并将文件夹路径，用户token，对应影片ID等参数传入客户端
    2. 客户端通过传入的用户token<登录用户详情接口>加载用户信息
    3. 客户端解析文件夹，为每个需要上载视频文件调用<新建上载任务接口>新建任务。
    4. 客户端对文件进行本地分块处理，同时调用<任务状态上传接口>更新任务状态
    5. 调用ipfs上载接口上传已经完成本地处理的文件
    6. 完成上传后，调用<任务状态上传接口>更新任务状态，导出私有块文件
2. 下载任务流程
    1. 在任务列表中已经通过甲方授权的影片资源，点击下载。此时调起本地客户端，执行下载。
    2. 客户端通过传入的用户token<登录用户详情接口>加载用户信息
    3. 客户端通过传入的影片ID调用<获取影视媒体IPFS下载Hash值接口>获取到下载影片资源的hash值
    4. 客户端通过调用<新建下载任务接口>进入下载公有块，并调用<任务状态上传接口>提交开始下载
    5. 客户端在下载公有块过程中定时调用<任务状态上传接口>上传下载进度
    6. 公有块下载完成后，客户端定时调用<查看下载任务详情接口>查询获取私有块是否已经上传成功。如果私有块已经上传，通过接口返回的私有块hash下载私有块。
    7. 客户端在下载公有块过程中调用<任务状态上传接口>上传下载进度
    8. 客户端进行本地解码合成，同时调用<任务状态上传接口>报告任务进度
3. 上载私有块任务流程
    1. 用户在任务中心点击私有块上传后，调起客户端
    2. 客户端调用<私有块上载任务列表接口>，拉取需要上传私有块的任务列表，并根据剧名分组
    3. 点击上传私有块，用户选择私有块文件夹，自动读取私有块文件进行匹配
    4. 调用ipfs上传已经成功匹配到的私有块
    5. 完成上传后，调用<任务状态上传接口>更新任务状态。
```

### 新建上载任务接口

##### HTTP Request

```
<PC>
新建上载任务时，使用影视系列ID新建上载任务, 任务默认状态未开始状态
```

> URL ```POST /api/v1/tasks/upload/pbulic/```

> Param ```FormData```

| 参数名 |  描述 | 类型 | 是否必传 | 默认值 | 备注 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| series_id | 系列ID | int | 是 | 无 | |
| uuid | 节目UUID | str | 是 | 无 | 为每条需要上传的节目母带文件创建一个UUID |
| source_name | 节目名，即初始视频文件名称 | str | 是 | 无 |

##### HTTP Response

```json
{
    "data": {
        "id": 233,                                             // 任务ID
        "status": 0,                                           // 任务状态 0=未开始；1=分块中；2=加密中；3=上载中；4=下载中；5=等待授权中(等待私有块上传中)；6=下载密钥中；7=合成中；8=已完成；9=出现错误
        "percent": 0,                                          // 具体进度 单位：百分点 0~100之间
        "series_id": 233,                                      // 节目系列ID
        "source_id": 233,                                      // 母带文件ID
        "source_name": "仙剑奇侠传-电视版（第21集）",               // 视频母带源文件名
        "uuid": "283509238",                                   // 节目母带的UUID
        "ip": "QmdUVasivefLGRkT4R9mzcp82Qoc47UBb5G9bHXdZkW3RP",// 上载机IP
        "file": "仙剑奇侠传",                                    // 文件夹名
        "name": "仙剑奇侠传-电视版（第21集）",                      // 公有块文件名
        "size": 102400,                                         // 公有块文件大小，单位：B
        "hash": "QmTxvr8VXe37apeBjyPeAGZi5JiRSbwn8mr2DuuqR517Lo", // 公有块IPFS Hash
        "created_at": "2018-05-06 12:00:00"                     // 任务创建时间
    },
    "message": ""                                               // 用户提示文案信息, 空则无需提示
}
```

### 提交上载任务状态接口

```
<PC>
1. 开始进行本地分块加密等处理时，提交更新状态
2. 本地处理结束，需要调用IPFS进行上传时，提交更新状态，同时将IPFS需要的相关数据上传
3. 最终IPFS上传成功或失败，提交更新状态
```

##### HTTP Request

> URL ```PATCH /api/v1/tasks/upload/pbulic/{任务ID}/```

> Param ```FormData```

| 参数名 |  描述 | 类型 | 是否必传 | 默认值 | 备注 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| status | 状态值 | int | 是 | 无 | 0=未开始；1=分块中；2=加密中；3=上载中；4=下载中；5=等待授权中(等待私有块上传中)；6=下载密钥中；7=合成中；8=已完成；9=出现错误 |
| percent | 数值 | int | 否 | 无 | 0~100的数字，只需要传可以拿到的进度，没有进度不需要传，完成传100 |
| name | 文件名 | str | 是 | 无 | 节目母带文件名 |
| file | 文件夹名称 | str | 是 | 无 | 节目母带文件夹名称 |
| hash | 文件HASH值 | str | 是 | 无 | 调用IPFS上传成功时返回的公有块Hash |
| size | 文件大小 | float | 是 | 无 | 公有块文件大小 |
| ip | 上载机IPFS的IP | str | 是 | 无 | |

##### HTTP Response

```json
{
    "data": {
        "id": 233,                                             // 任务ID
        "status": 0,                                           // 任务状态 0=未开始；1=分块中；2=加密中；3=上载中；4=下载中；5=等待授权中(等待私有块上传中)；6=下载密钥中；7=合成中；8=已完成；9=出现错误
        "percent": 0,                                          // 具体进度 单位：百分点 0~100之间
        "series_id": 233,                                      // 节目系列ID
        "source_id": 233,                                      // 母带文件ID
        "source_name": "仙剑奇侠传-电视版（第21集）",               // 视频母带源文件名
        "uuid": "283509238",                                   // 节目母带的UUID
        "ip": "QmdUVasivefLGRkT4R9mzcp82Qoc47UBb5G9bHXdZkW3RP",// 上载机IP
        "file": "仙剑奇侠传",                                    // 文件夹名
        "name": "仙剑奇侠传-电视版（第21集）",                      // 公有块文件名
        "size": 102400,                                         // 公有块文件大小，单位：B
        "hash": "QmTxvr8VXe37apeBjyPeAGZi5JiRSbwn8mr2DuuqR517Lo", // 公有块IPFS Hash
        "created_at": "2018-05-06 12:00:00"                     // 任务创建时间
    },
    "message": ""                                               // 用户提示文案信息, 空则无需提示
}
```

### 新建下载任务接口

```
<PC>
下载公有块文件时，使用节目ID新建一个下载任务。
如果成功新建任务，则会返回该节目的响应信息及在调用IPFS命令进行下载时最重要的IPFS Hash值
如果新建任务失败，这会返回服务端拒绝下载该节目的报错提示信息
```

##### HTTP Request

> URL ```GET /api/v1/tasks/download/```

> Param ```FormData```

| 参数名 |  描述 | 类型 | 是否必传 | 默认值 | 备注 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| source_id | 节目ID | int | 是 | 无 | |

##### HTTP Response

```json
{
    "data": {
        "id": 233,                                             // 任务ID
        "status": 0,                                           // 任务状态 0=未开始；1=分块中；2=加密中；3=上载中；4=下载中；5=等待授权中(等待私有块上传中)；6=下载密钥中；7=合成中；8=已完成；9=出现错误
        "percent": 0,                                          // 具体进度 单位：百分点 0~100之间
        "series_id": 233,                                      // 节目系列ID
        "source_id": 233,                                      // 母带文件ID
        "source_name": "仙剑奇侠传-电视版（第21集）",               // 视频母带源文件名
        "uuid": "283509238",                                   // 节目母带的UUID
        "ip": "QmdUVasivefLGRkT4R9mzcp82Qoc47UBb5G9bHXdZkW3RP",// 上载机IP
        "file": "仙剑奇侠传",                                    // 文件夹名
        "name": "仙剑奇侠传-电视版（第21集）",                      // 公有块文件名
        "size": 102400,                                         // 公有块文件大小，单位：B
        "hash": "QmTxvr8VXe37apeBjyPeAGZi5JiRSbwn8mr2DuuqR517Lo", // 公有块IPFS Hash
        "created_at": "2018-05-06 12:00:00",                     // 任务创建时间
        "private_status": 0,                                     // 私有块上载任务状态 0=未开始；1=分块中；2=加密中；3=上载中；4=下载中；5=等待授权中(等待私有块上传中)；6=下载密钥中；7=合成中；8=已完成；9=出现错误
        "private_name": "仙剑奇侠传-电视版（第21集）",               // 私有块文件名
        "private_size": 0,                                      // 私有块文件大小，单位：B
        "private_hash": ""                                      // 私有块IPFS Hash
    },
    "message": ""                                               // 用户提示文案信息, 空则无需提示
}
```

### 提交下载任务状态接口

```
<PC>
1. 开始下载公有块开始至公有块下载完成，定时上传下载进度，更新任务状态
2. 开始下载私有块开始至私有块下载完成，定时上传下载进度，更新任务状态
3. 开始本地合成， 更新任务状态
4. 合成结束，整个下载任务结束，更新任务状态
```

##### HTTP Request

> URL ```PATCH /api/v1/tasks/download/{任务ID}/```

> Param ```FormData```

| 参数名 |  描述 | 类型 | 是否必传 | 默认值 | 备注 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| status | 状态值 | int | 是 | 无 | 0=未开始；1=分块中；2=加密中；3=上载中；4=下载中；5=等待授权中(等待私有块上传中)；6=下载密钥中；7=合成中；8=已完成；9=出现错误|
| percent | 数值 | int | 否 | 无 | 0~100的数字，只需要在能拿到进度的状态下上传即可，其他只需要在完成是传100|

##### HTTP Response

```json
{
    "data": {
        "id": 233,                                             // 任务ID
        "status": 0,                                           // 任务状态 0=未开始；1=分块中；2=加密中；3=上载中；4=下载中；5=等待授权中(等待私有块上传中)；6=下载密钥中；7=合成中；8=已完成；9=出现错误
        "percent": 0,                                          // 具体进度 单位：百分点 0~100之间
        "series_id": 233,                                      // 节目系列ID
        "source_id": 233,                                      // 母带文件ID
        "source_name": "仙剑奇侠传-电视版（第21集）",               // 视频母带源文件名
        "uuid": "283509238",                                   // 节目母带的UUID
        "ip": "QmdUVasivefLGRkT4R9mzcp82Qoc47UBb5G9bHXdZkW3RP",// 上载机IP
        "file": "仙剑奇侠传",                                    // 文件夹名
        "name": "仙剑奇侠传-电视版（第21集）",                      // 公有块文件名
        "size": 102400,                                         // 公有块文件大小，单位：B
        "hash": "QmTxvr8VXe37apeBjyPeAGZi5JiRSbwn8mr2DuuqR517Lo", // 公有块IPFS Hash
        "created_at": "2018-05-06 12:00:00",                    // 任务创建时间
        "private_status": 0,                                     // 私有块上载任务状态 0=未开始；1=分块中；2=加密中；3=上载中；4=下载中；5=等待授权中(等待私有块上传中)；6=下载密钥中；7=合成中；8=已完成；9=出现错误
        "private_name": "仙剑奇侠传-电视版（第21集）",               // 私有块文件名
        "private_size": 0,                                      // 私有块文件大小，单位：B
        "private_hash": ""                                      // 私有块IPFS Hash
    },
    "message": ""                                               // 用户提示文案信息, 空则无需提示
}
```

### 获取下载任务详情接口

```
<PC>
当公有块下载完成后，定时查询任务的私有块IPFS的Hash值，直至获取到私有块IPFS Hash，更新任务状态
```

##### HTTP Request

> URL ```GET /api/v1/tasks/download/{任务ID}/```

##### HTTP Response

```json
{
    "data": {
        "id": 233,                                             // 任务ID
        "status": 0,                                           // 任务状态 0=未开始；1=分块中；2=加密中；3=上载中；4=下载中；5=等待授权中(等待私有块上传中)；6=下载密钥中；7=合成中；8=已完成；9=出现错误
        "percent": 0,                                          // 具体进度 单位：百分点 0~100之间
        "series_id": 233,                                      // 节目系列ID
        "source_id": 233,                                      // 母带文件ID
        "source_name": "仙剑奇侠传-电视版（第21集）",               // 视频母带源文件名
        "uuid": "283509238",                                   // 节目母带的UUID
        "ip": "QmdUVasivefLGRkT4R9mzcp82Qoc47UBb5G9bHXdZkW3RP",// 上载机IP
        "file": "仙剑奇侠传",                                    // 文件夹名
        "name": "仙剑奇侠传-电视版（第21集）",                      // 公有块文件名
        "size": 102400,                                         // 公有块文件大小，单位：B
        "hash": "QmTxvr8VXe37apeBjyPeAGZi5JiRSbwn8mr2DuuqR517Lo", // 公有块IPFS Hash
        "created_at": "2018-05-06 12:00:00",                     // 任务创建时间
        "private_status": 0,                                     // 私有块上载任务状态 0=未开始；1=分块中；2=加密中；3=上载中；4=下载中；5=等待授权中(等待私有块上传中)；6=下载密钥中；7=合成中；8=已完成；9=出现错误
        "private_name": "仙剑奇侠传-电视版（第21集）",               // 私有块文件名
        "private_size": 0,                                      // 私有块文件大小，单位：B
        "private_hash": ""                                      // 私有块IPFS Hash
    },
    "message": ""                                               // 用户提示文案信息, 空则无需提示
}
```

### 获取私有块上载任务列表接口

```
<PC>
当用户在Web端点击上传私有块文件后，调起客户端时，查询需要上传的私有块列表
```

##### HTTP Request

> URL ```GET /api/v1/tasks/upload/private/```

##### HTTP Response

```json
{
    "data": [
        {
            "id": 233,                                             // 任务ID
            "status": 0,                                           // 任务状态 0=未开始；1=分块中；2=加密中；3=上载中；4=下载中；5=等待授权中(等待私有块上传中)；6=下载密钥中；7=合成中；8=已完成；9=出现错误
            "percent": 0,                                          // 具体进度 单位：百分点 0~100之间
            "series_id": 233,                                      // 节目系列ID
            "source_id": 233,                                      // 母带文件ID
            "source_name": "仙剑奇侠传-电视版（第21集）",               // 视频母带源文件名
            "uuid": "283509238",                                   // 节目母带的UUID
            "ip": "QmdUVasivefLGRkT4R9mzcp82Qoc47UBb5G9bHXdZkW3RP",// 上载机IP
            "file": "仙剑奇侠传",                                    // 文件夹名
            "name": "仙剑奇侠传-电视版（第21集）",                      // 公有块文件名
            "size": 102400,                                         // 公有块文件大小，单位：B
            "hash": "QmTxvr8VXe37apeBjyPeAGZi5JiRSbwn8mr2DuuqR517Lo", // 公有块IPFS Hash
            "created_at": "2018-05-06 12:00:00"                     // 任务创建时间
        }
    ],
    "message": "",
    "meta": {
        "status_choices": [
            {
                "code": 0,
                "name": "未开始"
            },
            {
                "code": 3,
                "name": "上载中"
            },
            {
                "code": 8,
                "name": "已完成"
            },
            {
                "code": 9,
                "name": "出现错误"
            }
        ]
    }
}
```

### 提交私有块上载任务状态接口

```
<PC>
1. 调用IPFS进行上传时，提交更新状态，同时将IPFS需要的相关数据上传
2. 最终IPFS上传成功或失败，提交更新状态
```
``

##### HTTP Request

> URL ```PATCH /api/v1/tasks/upload/private/{任务ID}```

> Param ```FormData```

| 参数名 |  描述 | 类型 | 是否必传 | 默认值 | 备注 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| status | 状态值 | int | 是 | 无 | 0=未开始；1=分块中；2=加密中；3=上载中；4=下载中；5=等待授权中(等待私有块上传中)；6=下载密钥中；7=合成中；8=已完成；9=出现错误|
| percent | 数值 | int | 否 | 无 | 0~100的数字，只需要传可以拿到的进度，没有进度不需要传 |
| name | 文件名 | str | 是 | 无 | 节目母带文件名 |
| file | 文件夹名称 | str | 是 | 无 | 节目母带文件夹名称 |
| hash | 文件HASH值 | str | 是 | 无 | 调用IPFS上传成功时返回的公有块Hash |
| size | 文件大小 | float | 是 | 无 | 公有块文件大小 |
| ip | 上载机IPFS的IP | str | 是 | 无 | |

##### HTTP Response

```json
{
    "data": {
        "id": 233,                                             // 任务ID
        "status": 0,                                           // 任务状态 0=未开始；1=分块中；2=加密中；3=上载中；4=下载中；5=等待授权中(等待私有块上传中)；6=下载密钥中；7=合成中；8=已完成；9=出现错误
        "percent": 0,                                          // 具体进度 单位：百分点 0~100之间
        "series_id": 233,                                      // 节目系列ID
        "source_id": 233,                                      // 母带文件ID
        "source_name": "仙剑奇侠传-电视版（第21集）",               // 视频母带源文件名
        "uuid": "283509238",                                   // 节目母带的UUID
        "ip": "QmdUVasivefLGRkT4R9mzcp82Qoc47UBb5G9bHXdZkW3RP",// 上载机IP
        "file": "仙剑奇侠传",                                    // 文件夹名
        "name": "仙剑奇侠传-电视版（第21集）",                      // 公有块文件名
        "size": 102400,                                         // 公有块文件大小，单位：B
        "hash": "QmTxvr8VXe37apeBjyPeAGZi5JiRSbwn8mr2DuuqR517Lo", // 公有块IPFS Hash
        "created_at": "2018-05-06 12:00:00"                     // 任务创建时间
    },
    "message": ""                                               // 用户提示文案信息, 空则无需提示
}
```

